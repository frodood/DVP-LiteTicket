

var mongoose = require('mongoose');
var Schema = mongoose.Schema;
var ObjectId = Schema.ObjectId;


var eventSchema = new Schema({
    type: {type: String, enum : ['comment','status','notification','reassign'], default: 'comment', required: true},
    body: {}
});

var ticketSchema = new Schema({

    created_at: {type:Date,default: Date.now,require:true},
    updated_at: {type:Date,default: Date.now,require:true},
    due_at: Date,
    type: {type: String, enum : ['question','complain','incident','action'], default: 'question', required: true},
    subject: { type: String, required: true, trim: true},
    reference: { type: String, required: true, unique: true},
    description: { type: String, required: true, trim: true},
    priority: {type: String, enum : ['urgent','high','normal','low'], default: 'normal', required: true},
    status: {type: String, enum : ['new','open','progressing','parked','solved','closed'], default: 'new', required: true},
    requester: {type: ObjectId,ref: 'ExternalUser'},
    submitter: {type: ObjectId,ref: 'User'},
    assignee: {type: ObjectId,ref: 'User'},
    assignee_group: [{type: ObjectId,ref: 'UserGroup'}],
    company: { type: Number, required: true },
    tenant: { type: Number, required: true },
    collaborators: [{type: ObjectId,ref: 'User'}],
    attachments: [{type: ObjectId,ref: 'Attachment'}],
    subtickets: [{type: ObjectId,ref: 'Ticket'}],
    related_tickets: [{type: ObjectId,ref: 'Ticket'}],
    channel: {type: String, enum: ['call', 'email', 'sms', 'facebook-post', 'facebook-chat', 'twitter','skype', 'api', 'web-widget'], default: 'api', required: true},
    tags: [String],
    custom_fields: [{field:{type:String, require: true},value:{}}],
    sla: [{type: ObjectId,ref: 'SLA'}],
    comments: [{type: ObjectId,ref: 'Comment'}],
    events: [eventSchema]

});



var TicketEvent = mongoose.model('Event', eventSchema);
var Ticket = mongoose.model('Ticket', ticketSchema);
module.exports.Ticket = Ticket;
module.exports.Event = TicketEvent;
